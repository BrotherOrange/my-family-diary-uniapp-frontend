{"version":3,"file":"mine.js","sources":["pages/mine/mine.vue","../../../HBuilderX.4.75.2025071105/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbWluZS9taW5lLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"container\">\r\n    <view class=\"user-card\" v-if=\"userInfo\">\r\n      <view class=\"avatar-container\" @tap=\"previewAvatar\">\r\n        <image class=\"avatar\" :src=\"userInfo.avatarUrl || '/static/logo.png'\" mode=\"aspectFill\"></image>\r\n        <!-- #ifdef MP-WEIXIN -->\r\n        <button\r\n          class=\"avatar-change-btn\"\r\n          open-type=\"chooseAvatar\"\r\n          @chooseavatar=\"onChooseAvatar\"\r\n          @tap.stop\r\n        >\r\n          <text class=\"change-icon\">&#x270E;</text>\r\n        </button>\r\n        <!-- #endif -->\r\n        <!-- #ifndef MP-WEIXIN -->\r\n        <view class=\"avatar-change-btn\" @tap.stop=\"chooseAvatar\">\r\n          <text class=\"change-icon\">&#x270E;</text>\r\n        </view>\r\n        <!-- #endif -->\r\n      </view>\r\n      <view class=\"user-details\">\r\n        <text class=\"username\">{{ userInfo.username || '用户' }}</text>\r\n        <text class=\"status\">{{ userInfo.status || '欢迎回来！' }}</text>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"menu-list\">\r\n      <view class=\"menu-item\">\r\n        <text class=\"menu-icon\">&#x1F4DD;</text>\r\n        <text class=\"menu-text\">写日记</text>\r\n      </view>\r\n      <view class=\"menu-item\">\r\n        <text class=\"menu-icon\">&#x1F4DA;</text>\r\n        <text class=\"menu-text\">我的日记</text>\r\n      </view>\r\n      <view class=\"menu-item\">\r\n        <text class=\"menu-icon\">&#x1F468;&#x200D;&#x1F469;&#x200D;&#x1F467;</text>\r\n        <text class=\"menu-text\">家庭成员</text>\r\n      </view>\r\n      <view class=\"menu-item\">\r\n        <text class=\"menu-icon\">&#x2699;&#xFE0F;</text>\r\n        <text class=\"menu-text\">设置</text>\r\n      </view>\r\n    </view>\r\n\r\n    <button class=\"logout-btn\" @tap=\"handleLogout\">退出登录</button>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref } from 'vue'\r\nimport { onShow } from '@dcloudio/uni-app'\r\nimport { uploadAvatar } from '@/api/cos'\r\n\r\n// 响应式状态\r\nconst userInfo = ref(null)\r\nconst uploading = ref(false)\r\n\r\n// 使用 onShow 而不是 onLoad，因为 tabBar 页面切换时只触发 onShow\r\nonShow(() => {\r\n  // Check login status\r\n  const token = uni.getStorageSync('token')\r\n  if (!token) {\r\n    navigateToLogin()\r\n    return\r\n  }\r\n\r\n  // Get user info\r\n  userInfo.value = uni.getStorageSync('userInfo') || {}\r\n})\r\n\r\n// 预览头像大图\r\nfunction previewAvatar() {\r\n  const avatarUrl = userInfo.value.avatarUrl || '/static/logo.png'\r\n  // 本地图片无法预览，给出提示\r\n  if (avatarUrl.startsWith('/static/')) {\r\n    uni.showToast({ title: '暂无头像', icon: 'none' })\r\n    return\r\n  }\r\n  uni.previewImage({\r\n    current: avatarUrl,\r\n    urls: [avatarUrl]\r\n  })\r\n}\r\n\r\n// 微信头像选择回调\r\nasync function onChooseAvatar(e) {\r\n  console.log('onChooseAvatar:', e.detail)\r\n  const { avatarUrl } = e.detail\r\n  if (avatarUrl) {\r\n    await uploadAndUpdateAvatar(avatarUrl)\r\n  }\r\n}\r\n\r\n// 非微信平台选择图片\r\nfunction chooseAvatar() {\r\n  uni.chooseImage({\r\n    count: 1,\r\n    sizeType: ['original'],\r\n    sourceType: ['album', 'camera'],\r\n    success: async (res) => {\r\n      console.log('chooseImage success:', res)\r\n      const tempFilePath = res.tempFilePaths[0]\r\n      await uploadAndUpdateAvatar(tempFilePath)\r\n    }\r\n  })\r\n}\r\n\r\n// 上传并更新头像\r\nasync function uploadAndUpdateAvatar(tempFilePath) {\r\n  if (uploading.value) return\r\n  uploading.value = true\r\n\r\n  uni.showLoading({ title: '上传中...' })\r\n\r\n  try {\r\n    // 将图片转为 Base64\r\n    const base64Image = await imageToBase64(tempFilePath)\r\n\r\n    // 获取 openId\r\n    const openId = userInfo.value.openId\r\n    if (!openId) {\r\n      throw new Error('用户信息异常，请重新登录')\r\n    }\r\n\r\n    // 上传到服务器\r\n    const res = await uploadAvatar(openId, base64Image)\r\n    const newAvatarUrl = res.data\r\n\r\n    // 更新本地数据\r\n    userInfo.value.avatarUrl = newAvatarUrl\r\n    uni.setStorageSync('userInfo', userInfo.value)\r\n\r\n    uni.hideLoading()\r\n    uni.showToast({ title: '头像更新成功', icon: 'success' })\r\n  } catch (err) {\r\n    console.error('上传头像失败:', err)\r\n    uni.hideLoading()\r\n    uni.showToast({ title: err.message || '上传失败，请重试', icon: 'none' })\r\n  } finally {\r\n    uploading.value = false\r\n  }\r\n}\r\n\r\n// 图片转 Base64（统一使用 png 格式前缀）\r\nfunction imageToBase64(filePath) {\r\n  return new Promise((resolve, reject) => {\r\n    // #ifdef MP-WEIXIN\r\n    const fs = uni.getFileSystemManager()\r\n    fs.readFile({\r\n      filePath: filePath,\r\n      encoding: 'base64',\r\n      success: (res) => {\r\n        // 统一使用 png 前缀，后端会保存为 .png 文件\r\n        resolve('data:image/png;base64,' + res.data)\r\n      },\r\n      fail: (err) => {\r\n        reject(err)\r\n      }\r\n    })\r\n    // #endif\r\n    // #ifdef H5\r\n    // H5 环境使用 canvas 转换\r\n    uni.getImageInfo({\r\n      src: filePath,\r\n      success: (info) => {\r\n        const canvas = document.createElement('canvas')\r\n        const ctx = canvas.getContext('2d')\r\n        const img = new Image()\r\n        img.crossOrigin = 'Anonymous'\r\n        img.onload = () => {\r\n          // 头像尺寸\r\n          const maxSize = 400\r\n          let width = img.width\r\n          let height = img.height\r\n          const minSide = Math.min(width, height)\r\n          const targetSize = Math.min(minSide, maxSize)\r\n          canvas.width = targetSize\r\n          canvas.height = targetSize\r\n          // 居中裁剪为正方形\r\n          const sx = (width - minSide) / 2\r\n          const sy = (height - minSide) / 2\r\n          ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, targetSize, targetSize)\r\n          // 返回带前缀的 base64\r\n          const base64 = canvas.toDataURL('image/png')\r\n          resolve(base64)\r\n        }\r\n        img.onerror = reject\r\n        img.src = filePath\r\n      },\r\n      fail: reject\r\n    })\r\n    // #endif\r\n  })\r\n}\r\n\r\nfunction handleLogout() {\r\n  uni.showModal({\r\n    title: '退出登录',\r\n    content: '确定要退出登录吗？',\r\n    confirmText: '确定',\r\n    cancelText: '取消',\r\n    success: (res) => {\r\n      if (res.confirm) {\r\n        uni.removeStorageSync('token')\r\n        uni.removeStorageSync('userInfo')\r\n        navigateToLogin()\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nfunction navigateToLogin() {\r\n  uni.reLaunch({\r\n    url: '/pages/login/login'\r\n  })\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.container {\r\n  min-height: 100vh;\r\n  padding: 30rpx;\r\n  padding-top: 60rpx;\r\n  background: #FFE8E0;\r\n}\r\n\r\n.user-card {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 40rpx;\r\n  background: #FF9A8B;\r\n  border-radius: 24rpx;\r\n  margin-bottom: 40rpx;\r\n}\r\n\r\n.avatar-container {\r\n  position: relative;\r\n  margin-right: 30rpx;\r\n\r\n  .avatar {\r\n    width: 120rpx;\r\n    height: 120rpx;\r\n    border-radius: 50%;\r\n    border: 4rpx solid rgba(255, 255, 255, 0.6);\r\n  }\r\n}\r\n\r\n.avatar-change-btn {\r\n  position: absolute;\r\n  right: -8rpx;\r\n  bottom: -8rpx;\r\n  width: 44rpx;\r\n  height: 44rpx;\r\n  min-height: 44rpx;\r\n  padding: 0;\r\n  margin: 0;\r\n  background: #ffffff;\r\n  border-radius: 50%;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15);\r\n  border: none;\r\n  line-height: 1;\r\n\r\n  &::after {\r\n    border: none;\r\n  }\r\n\r\n  .change-icon {\r\n    font-size: 24rpx;\r\n    color: #FF7B6B;\r\n  }\r\n}\r\n\r\n.user-details {\r\n  flex: 1;\r\n\r\n  .username {\r\n    display: block;\r\n    font-size: 36rpx;\r\n    font-weight: 600;\r\n    color: #ffffff;\r\n    margin-bottom: 10rpx;\r\n  }\r\n\r\n  .status {\r\n    font-size: 26rpx;\r\n    color: rgba(255, 255, 255, 0.9);\r\n  }\r\n}\r\n\r\n.menu-list {\r\n  background: #FFEDE8;\r\n  border-radius: 24rpx;\r\n  overflow: hidden;\r\n  box-shadow: 0 4rpx 16rpx rgba(255, 154, 139, 0.1);\r\n}\r\n\r\n.menu-item {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 40rpx 30rpx;\r\n  border-bottom: 1rpx solid #FFF0EB;\r\n\r\n  &:last-child {\r\n    border-bottom: none;\r\n  }\r\n\r\n  &:active {\r\n    background: #FFE0D9;\r\n  }\r\n\r\n  .menu-icon {\r\n    font-size: 44rpx;\r\n    margin-right: 30rpx;\r\n  }\r\n\r\n  .menu-text {\r\n    font-size: 32rpx;\r\n    color: #333333;\r\n  }\r\n}\r\n\r\n.logout-btn {\r\n  margin-top: 60rpx;\r\n  background: #FF7B6B;\r\n  color: #ffffff;\r\n  font-size: 32rpx;\r\n  border-radius: 20rpx;\r\n  border: none;\r\n\r\n  &::after {\r\n    border: none;\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'D:/my-family-diary/my-family-diary-uniapp-frontend/MyFamilyDiary/pages/mine/mine.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onShow","uni","uploadAvatar"],"mappings":";;;;;;AAwDA,UAAM,WAAWA,cAAG,IAAC,IAAI;AACzB,UAAM,YAAYA,cAAG,IAAC,KAAK;AAG3BC,kBAAAA,OAAO,MAAM;AAEX,YAAM,QAAQC,cAAAA,MAAI,eAAe,OAAO;AACxC,UAAI,CAAC,OAAO;AACV,wBAAiB;AACjB;AAAA,MACD;AAGD,eAAS,QAAQA,cAAAA,MAAI,eAAe,UAAU,KAAK,CAAE;AAAA,IACvD,CAAC;AAGD,aAAS,gBAAgB;AACvB,YAAM,YAAY,SAAS,MAAM,aAAa;AAE9C,UAAI,UAAU,WAAW,UAAU,GAAG;AACpCA,sBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAC7C;AAAA,MACD;AACDA,oBAAAA,MAAI,aAAa;AAAA,QACf,SAAS;AAAA,QACT,MAAM,CAAC,SAAS;AAAA,MACpB,CAAG;AAAA,IACH;AAGA,mBAAe,eAAe,GAAG;AAC/BA,oBAAA,MAAA,MAAA,OAAA,6BAAY,mBAAmB,EAAE,MAAM;AACvC,YAAM,EAAE,cAAc,EAAE;AACxB,UAAI,WAAW;AACb,cAAM,sBAAsB,SAAS;AAAA,MACtC;AAAA,IACH;AAiBA,mBAAe,sBAAsB,cAAc;AACjD,UAAI,UAAU;AAAO;AACrB,gBAAU,QAAQ;AAElBA,oBAAAA,MAAI,YAAY,EAAE,OAAO,SAAQ,CAAE;AAEnC,UAAI;AAEF,cAAM,cAAc,MAAM,cAAc,YAAY;AAGpD,cAAM,SAAS,SAAS,MAAM;AAC9B,YAAI,CAAC,QAAQ;AACX,gBAAM,IAAI,MAAM,cAAc;AAAA,QAC/B;AAGD,cAAM,MAAM,MAAMC,qBAAa,QAAQ,WAAW;AAClD,cAAM,eAAe,IAAI;AAGzB,iBAAS,MAAM,YAAY;AAC3BD,sBAAAA,MAAI,eAAe,YAAY,SAAS,KAAK;AAE7CA,sBAAAA,MAAI,YAAa;AACjBA,sBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,WAAW;AAAA,MACnD,SAAQ,KAAK;AACZA,sBAAAA,mDAAc,WAAW,GAAG;AAC5BA,sBAAAA,MAAI,YAAa;AACjBA,4BAAI,UAAU,EAAE,OAAO,IAAI,WAAW,YAAY,MAAM,QAAQ;AAAA,MACpE,UAAY;AACR,kBAAU,QAAQ;AAAA,MACnB;AAAA,IACH;AAGA,aAAS,cAAc,UAAU;AAC/B,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEtC,cAAM,KAAKA,cAAG,MAAC,qBAAsB;AACrC,WAAG,SAAS;AAAA,UACV;AAAA,UACA,UAAU;AAAA,UACV,SAAS,CAAC,QAAQ;AAEhB,oBAAQ,2BAA2B,IAAI,IAAI;AAAA,UAC5C;AAAA,UACD,MAAM,CAAC,QAAQ;AACb,mBAAO,GAAG;AAAA,UACX;AAAA,QACP,CAAK;AAAA,MAkCL,CAAG;AAAA,IACH;AAEA,aAAS,eAAe;AACtBA,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,SAAS;AAAA,QACT,aAAa;AAAA,QACb,YAAY;AAAA,QACZ,SAAS,CAAC,QAAQ;AAChB,cAAI,IAAI,SAAS;AACfA,0BAAG,MAAC,kBAAkB,OAAO;AAC7BA,0BAAG,MAAC,kBAAkB,UAAU;AAChC,4BAAiB;AAAA,UAClB;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IACH;AAEA,aAAS,kBAAkB;AACzBA,oBAAAA,MAAI,SAAS;AAAA,QACX,KAAK;AAAA,MACT,CAAG;AAAA,IACH;;;;;;;;;;;;;;;;;;;ACxNA,GAAG,WAAW,eAAe;"}